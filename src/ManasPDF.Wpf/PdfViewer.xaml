<UserControl x:Class="ManasPDF.Wpf.PdfViewer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="#F0F0F0"
             Focusable="True">

    <UserControl.Resources>
        <DropShadowEffect x:Key="PageShadow" BlurRadius="8" ShadowDepth="2"
                          Opacity="0.2" Direction="270" />
        <Style x:Key="ToolbarButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Margin" Value="2,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Foreground" Value="#333" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E0E0E0" />
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="ToolbarSeparator" TargetType="Border">
            <Setter Property="Width" Value="1" />
            <Setter Property="Background" Value="#CCC" />
            <Setter Property="Margin" Value="6,4" />
        </Style>
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding Gesture="Ctrl+F" Command="{x:Static ApplicationCommands.Find}" />
        <KeyBinding Gesture="Ctrl+P" Command="{x:Static ApplicationCommands.Print}" />
        <KeyBinding Gesture="Ctrl+S" Command="{x:Static ApplicationCommands.SaveAs}" />
        <KeyBinding Gesture="Ctrl+C" Command="{x:Static ApplicationCommands.Copy}" />
    </UserControl.InputBindings>

    <UserControl.CommandBindings>
        <CommandBinding Command="{x:Static ApplicationCommands.Find}" Executed="FindCommand_Executed" />
        <CommandBinding Command="{x:Static ApplicationCommands.Print}" Executed="PrintCommand_Executed" />
        <CommandBinding Command="{x:Static ApplicationCommands.SaveAs}" Executed="SaveAsCommand_Executed" />
        <CommandBinding Command="{x:Static ApplicationCommands.Copy}" Executed="CopyCommand_Executed" />
    </UserControl.CommandBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="#FAFAFA" BorderBrush="#DDD" BorderThickness="0,0,0,1"
                Padding="8,4" x:Name="ToolbarPanel">
            <DockPanel>
                <!-- Left: Navigation -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="&#x25C0;" Style="{StaticResource ToolbarButton}" Click="PrevPage_Click" ToolTip="Previous Page" />
                    <TextBox x:Name="PageNumberBox" Width="45" VerticalAlignment="Center"
                             HorizontalContentAlignment="Center" FontSize="13" Margin="4,0"
                             KeyDown="PageNumberBox_KeyDown" />
                    <TextBlock x:Name="PageCountText" VerticalAlignment="Center" FontSize="13"
                               Foreground="#666" Margin="2,0,0,0" />
                    <Button Content="&#x25B6;" Style="{StaticResource ToolbarButton}" Click="NextPage_Click" ToolTip="Next Page" />

                    <Border Style="{StaticResource ToolbarSeparator}" />

                    <!-- Zoom -->
                    <Button Content="&#x2212;" Style="{StaticResource ToolbarButton}" Click="ZoomOut_Click" ToolTip="Zoom Out (Ctrl+-)" FontSize="16" />
                    <TextBlock x:Name="ZoomText" VerticalAlignment="Center" FontSize="13"
                               Foreground="#666" Margin="4,0" MinWidth="45" TextAlignment="Center" />
                    <Button Content="+" Style="{StaticResource ToolbarButton}" Click="ZoomIn_Click" ToolTip="Zoom In (Ctrl++)" FontSize="16" />

                    <Border Style="{StaticResource ToolbarSeparator}" />

                    <!-- Rotate -->
                    <Button Content="&#x21BB;" Style="{StaticResource ToolbarButton}" Click="Rotate_Click"
                            ToolTip="Rotate 90Â° (Ctrl+R)" FontSize="16" FontWeight="Bold" />
                </StackPanel>

                <!-- Right: Actions -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- Search -->
                    <Button Content="&#x1F50D;" Style="{StaticResource ToolbarButton}" Click="SearchButton_Click"
                            ToolTip="Find (Ctrl+F)" FontSize="14" />

                    <Border Style="{StaticResource ToolbarSeparator}" />

                    <!-- Print -->
                    <Button Content="&#x1F5A8;" Style="{StaticResource ToolbarButton}" Click="Print_Click"
                            ToolTip="Print (Ctrl+P)" FontSize="14" />

                    <!-- Save As -->
                    <Button Content="&#x1F4BE;" Style="{StaticResource ToolbarButton}" Click="SaveAs_Click"
                            ToolTip="Save As (Ctrl+S)" FontSize="14" />
                </StackPanel>

                <!-- Center: spacer -->
                <Border />
            </DockPanel>
        </Border>

        <!-- Search Bar (collapsible) -->
        <Border Grid.Row="1" x:Name="SearchBarPanel" Background="#FFFDE7" BorderBrush="#DDD"
                BorderThickness="0,0,0,1" Padding="8,4" Visibility="Collapsed">
            <DockPanel>
                <Button DockPanel.Dock="Right" Content="&#x2715;" Style="{StaticResource ToolbarButton}"
                        Click="CloseSearch_Click" ToolTip="Close" FontSize="12" Margin="4,0,0,0" />
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
                    <Button Content="&#x25B2;" Style="{StaticResource ToolbarButton}" Click="PrevMatch_Click"
                            ToolTip="Previous Match (Shift+Enter)" FontSize="10" Padding="6,4" />
                    <TextBlock x:Name="MatchCountText" VerticalAlignment="Center" FontSize="12"
                               Foreground="#666" Margin="4,0" MinWidth="50" TextAlignment="Center" />
                    <Button Content="&#x25BC;" Style="{StaticResource ToolbarButton}" Click="NextMatch_Click"
                            ToolTip="Next Match (Enter)" FontSize="10" Padding="6,4" />
                </StackPanel>
                <TextBox x:Name="SearchTextBox" FontSize="13" Padding="4,2" VerticalAlignment="Center"
                         TextChanged="SearchTextBox_TextChanged" KeyDown="SearchTextBox_KeyDown" />
            </DockPanel>
        </Border>

        <!-- PDF Content -->
        <ScrollViewer Grid.Row="2" x:Name="PdfScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      Background="#E8E8E8"
                      PreviewMouseWheel="PdfScrollViewer_PreviewMouseWheel"
                      ScrollChanged="PdfScrollViewer_ScrollChanged">
            <ItemsControl x:Name="PdfPagesContainer">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical" HorizontalAlignment="Center" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White" Margin="0,12" HorizontalAlignment="Center"
                                BorderBrush="#CCC" BorderThickness="1"
                                Effect="{StaticResource PageShadow}">
                            <Grid>
                                <Image Source="{Binding PageImage}" Stretch="None"
                                       RenderOptions.BitmapScalingMode="HighQuality">
                                    <Image.LayoutTransform>
                                        <RotateTransform Angle="{Binding RotationAngle}" />
                                    </Image.LayoutTransform>
                                </Image>
                                <!-- Overlay canvas for highlights (search, selection, links) -->
                                <Canvas x:Name="OverlayCanvas" IsHitTestVisible="True"
                                        Background="Transparent"
                                        Width="{Binding OverlayWidth}" Height="{Binding OverlayHeight}">
                                    <Canvas.LayoutTransform>
                                        <RotateTransform Angle="{Binding RotationAngle}" />
                                    </Canvas.LayoutTransform>
                                </Canvas>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Loading overlay -->
        <Border Grid.Row="2" x:Name="LoadingOverlay" Visibility="Collapsed"
                Background="#80FFFFFF" IsHitTestVisible="False">
            <TextBlock Text="Loading..." HorizontalAlignment="Center"
                       VerticalAlignment="Center" FontSize="16" Foreground="#666" />
        </Border>
    </Grid>
</UserControl>
